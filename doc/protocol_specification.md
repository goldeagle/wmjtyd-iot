# 服务端与嵌入式设备通信协议规范 v1.0

## 1. 协议概述

本协议规范定义了服务端与嵌入式设备之间的通信标准，采用二进制格式以确保通信效率和资源占用最小化。

## 2. 通用协议定义

### 2.1 协议格式
```
[帧头(2字节)] [长度(2字节)] [设备地址(1字节)] [传感器类型(1字节)] [命令字(1字节)] [数据区(N字节)] [校验和(2字节)]
```

字段说明：
| 字段       | 长度(字节) | 说明                            |
| ---------- | ---------- | ------------------------------- |
| 帧头       | 2          | 固定值：0xAA 0x55               |
| 长度       | 2          | 从设备地址到数据区的长度        |
| 设备地址   | 1          | 设备的唯一标识                  |
| 传感器类型 | 1          | 定义传感器的类型                |
| 命令字     | 1          | 定义消息类型                    |
| 数据区     | N          | 具体的数据内容                  |
| 校验和     | 2          | CRC16校验（从设备地址到数据区） |

### 2.2 传感器类型定义

| 传感器类型 | 值 | 说明 |
|------------|-----|------|
| 六合一传感器 | 0x01 | 温度、湿度、CO2、PM2.5、TVOC、CH2O |
| 应变传感器 | 0x02 | 应变、温度 |
| 位移传感器 | 0x03 | 位移、温度 |
| 噪声传感器 | 0x04 | 噪声、温度 |
| 保留 | 0x05-0xFE | 预留给其他传感器类型 |
| 自定义传感器 | 0xFF | 用户自定义传感器类型 |

### 2.3 通用命令字定义

| 命令字 | 值 | 说明 |
|--------|-----|------|
| 心跳包 | 0x01 | 设备定期发送心跳信息 |
| 数据上报 | 0x02 | 设备数据上报 |
| 参数设置 | 0x03 | 设置设备参数 |
| 参数查询 | 0x04 | 查询设备参数 |
| 控制命令 | 0x05 | 控制设备动作 |
| 状态查询 | 0x06 | 查询设备状态 |
| 配置响应 | 0x07 | 响应配置命令 |
| 错误报告 | 0x08 | 报告错误状态 |

### 2.4 数据区格式
数据区根据命令字不同，采用不同的格式：

1. 心跳包（0x01）：
```
[设备类型(1字节)] [运行时间(4字节)] [状态(1字节)]
```

2. 数据上报（0x02）：
每种传感器类型都有其固定的数据格式，一次上报所有数据。

2.1 六合一传感器数据上报格式：
```
[温度(2字节)] [湿度(2字节)] [CO2(2字节)] [PM2.5(2字节)] [TVOC(2字节)] [CH2O(2字节)]
```
- 温度：实际值 = 读数 / 10 (℃)
- 湿度：实际值 = 读数 / 10 (%RH)
- CO2：实际值 = 读数 (ppm)
- PM2.5：实际值 = 读数 (μg/m³)
- TVOC：实际值 = 读数 (ppb)
- CH2O：实际值 = 读数 / 100 (mg/m³)

2.2 应变传感器数据上报格式：
```
[应变值(4字节)] [温度(2字节)]
```
- 应变值：实际值 = 读数 (με)
- 温度：实际值 = 读数 / 10 (℃)

2.3 位移传感器数据上报格式：
```
[位移值(4字节)] [温度(2字节)]
```
- 位移值：实际值 = 读数 / 100 (mm)
- 温度：实际值 = 读数 / 10 (℃)

2.4 噪声传感器数据上报格式：
```
[噪声值(2字节)] [温度(2字节)]
```
- 噪声值：实际值 = 读数 / 10 (dB)
- 温度：实际值 = 读数 / 10 (℃)

3. 参数设置（0x03）：
```
[参数ID(1字节)] [参数长度(1字节)] [参数值(N字节)]
```

4. 参数查询（0x04）：
```
[参数ID(1字节)]
```

5. 控制命令（0x05）：
```
[命令ID(1字节)] [参数长度(1字节)] [参数值(N字节)]
```

## 3. 示例

### 3.1 数据上报示例

#### 3.1.1 六合一传感器数据上报
```
AA 55      // 帧头
00 0D      // 长度(13字节)
01         // 设备地址
01         // 传感器类型(六合一传感器)
02         // 命令字(数据上报)
01 90      // 温度 25.0℃
02 58      // 湿度 60.0%RH
03 E8      // CO2 1000ppm
00 1E      // PM2.5 30μg/m³
01 F4      // TVOC 500ppb
00 64      // CH2O 1.00mg/m³
XX XX      // CRC校验和
```

#### 3.1.2 应变传感器数据上报
```
AA 55      // 帧头
00 09      // 长度(9字节)
01         // 设备地址
02         // 传感器类型(应变传感器)
02         // 命令字(数据上报)
00 00 03 E8 // 应变值 1000με
01 90      // 温度 25.0℃
XX XX      // CRC校验和
```

## 4. 版本历史

| 版本 | 日期 | 修改说明 |
|------|------|----------|
| 1.0 | 2025-03-14 | 初始版本 |
